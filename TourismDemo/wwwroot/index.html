<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢—É—Ä–∏—Å—Ç–∏—á–Ω—ñ —Ç—É—Ä–∏ - –î–µ–º–æ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 30px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        text-align: center;
      }

      .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }

      .content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 40px;
      }

      @media (max-width: 768px) {
        .content {
          grid-template-columns: 1fr;
        }
        .full-width {
          grid-column: 1 !important;
        }
      }

      .section {
        display: flex;
        flex-direction: column;
      }

      .full-width {
        grid-column: 1 / -1;
      }

      h2 {
        color: #667eea;
        font-size: 18px;
        margin-bottom: 15px;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        font-size: 14px;
      }

      th {
        background: #667eea;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
      }

      td {
        padding: 12px;
        border-bottom: 1px solid #eee;
      }

      tr:hover {
        background: #f5f5f5;
      }

      .form-group {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
      }

      label {
        color: #333;
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 14px;
      }

      input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      button {
        background: #667eea;
        color: white;
        padding: 10px 16px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
        margin-top: 10px;
      }

      button:hover {
        background: #764ba2;
      }

      button:active {
        transform: scale(0.98);
      }

      button.delete {
        background: #dc3545;
        padding: 6px 12px;
        margin-top: 0;
        font-size: 12px;
      }

      button.delete:hover {
        background: #c82333;
      }

      .message {
        padding: 12px;
        border-radius: 5px;
        margin-top: 15px;
        font-size: 14px;
        display: none;
      }

      .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        display: block;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        display: block;
      }

      .loading {
        text-align: center;
        color: #667eea;
        font-size: 14px;
      }

      .empty-state {
        text-align: center;
        color: #999;
        padding: 20px;
      }

      .price {
        color: #28a745;
        font-weight: 600;
      }

      .rating {
        color: #ffc107;
        font-weight: 600;
      }

      .actions {
        text-align: center;
      }

      .booking-date {
        font-size: 12px;
        color: #666;
      }

      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .refresh-btn {
        background: #28a745;
        padding: 8px 16px;
        font-size: 14px;
        margin-top: 0;
      }

      .refresh-btn:hover {
        background: #218838;
      }

      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #eee;
      }

      .tab-btn {
        padding: 10px 20px;
        background: none;
        border: none;
        color: #666;
        font-weight: 600;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: all 0.3s;
      }

      .tab-btn.active {
        color: #667eea;
        border-bottom-color: #667eea;
        background: #f5f5f5;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }

      textarea {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        font-family: Arial, sans-serif;
        resize: vertical;
        min-height: 80px;
      }

      textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      select:focus {
        outline: none;
        border-color: #667eea;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üèñÔ∏è –ï–∫–æ—Å–∏—Å—Ç–µ–º–∞ —Ç—É—Ä–∏–∑–º—É</h1>
      <p class="subtitle">
        –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ–π–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç—É—Ä–∞–º–∏ —Ç–∞ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è–º
      </p>

      <!-- –í–∫–ª–∞–¥–∫–∏ –¥–ª—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('tours')">
          üìã –¢—É—Ä–∏
        </button>
        <button class="tab-btn" onclick="switchTab('bookings')">
          ‚úàÔ∏è –ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è
        </button>
        <button class="tab-btn" onclick="switchTab('reviews')">
          ‚≠ê –í—ñ–¥–≥—É–∫–∏
        </button>
        <button class="tab-btn" onclick="switchTab('payments')">
          üí≥ –ü–ª–∞—Ç–µ–∂—ñ
        </button>
      </div>

      <!-- ===== TAB 1: TOURS ===== -->
      <div id="tours" class="tab-content active">
        <div class="content full-width">
          <!-- –§–æ—Ä–º–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç—É—Ä—É -->
          <div class="section">
            <h2>‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π —Ç—É—Ä</h2>
            <form id="createTourForm">
              <div class="form-group">
                <label for="tourName">–ù–∞–∑–≤–∞ —Ç—É—Ä—É *</label>
                <input
                  type="text"
                  id="tourName"
                  required
                  placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ç—É—Ä—É"
                />
              </div>
              <div class="form-group">
                <label for="tourDescription">–û–ø–∏—Å</label>
                <textarea
                  id="tourDescription"
                  placeholder="–û–ø–∏—Å —Ç—É—Ä—É..."
                ></textarea>
              </div>
              <div class="form-group">
                <label for="tourCityId">ID –º—ñ—Å—Ç–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è *</label>
                <input type="number" id="tourCityId" required min="1" />
              </div>
              <div class="form-group">
                <label for="tourDuration">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –¥–Ω—ñ–≤ *</label>
                <input type="number" id="tourDuration" required min="1" />
              </div>
              <div class="form-group">
                <label for="tourMaxParticipants">–ú–∞–∫—Å —É—á–∞—Å–Ω–∏–∫—ñ–≤ *</label>
                <input
                  type="number"
                  id="tourMaxParticipants"
                  required
                  min="1"
                />
              </div>
              <div class="form-group">
                <label for="tourPrice">–¶—ñ–Ω–∞ ($) *</label>
                <input
                  type="number"
                  id="tourPrice"
                  required
                  min="0.01"
                  step="0.01"
                />
              </div>
              <div class="form-group">
                <label for="tourDifficulty">–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å</label>
                <select id="tourDifficulty">
                  <option value="Easy">–õ–µ–≥–∫–æ</option>
                  <option value="Medium" selected>–°–µ—Ä–µ–¥–Ω—å–æ</option>
                  <option value="Hard">–í–∞–∂–∫–æ</option>
                </select>
              </div>
              <button type="submit">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç—É—Ä</button>
              <div id="createTourMessage" class="message"></div>
            </form>
          </div>
        </div>

        <div class="content">
          <!-- –°–ø–∏—Å–æ–∫ —Ç—É—Ä—ñ–≤ -->
          <div class="section">
            <h2>üìã –î–æ—Å—Ç—É–ø–Ω—ñ —Ç—É—Ä–∏</h2>
            <div id="toursLoading" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç—É—Ä—ñ–≤...</div>
            <table id="toursTable" style="display: none">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>–ù–∞–∑–≤–∞</th>
                  <th>–ö—Ä–∞—ó–Ω–∞</th>
                  <th>–ú—ñ—Å—Ç–æ</th>
                  <th>–¶—ñ–Ω–∞</th>
                  <th>–†–µ–π—Ç–∏–Ω–≥</th>
                </tr>
              </thead>
              <tbody id="toursTableBody"></tbody>
            </table>
            <div id="toursEmpty" class="empty-state">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ç—É—Ä—ñ–≤</div>
          </div>

          <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ñ —Ç—É—Ä–∏ -->
          <div class="section">
            <h2>üî• –ü–æ–ø—É–ª—è—Ä–Ω—ñ —Ç—É—Ä–∏</h2>
            <div id="popularLoading" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            <table id="popularTable" style="display: none">
              <thead>
                <tr>
                  <th>–ù–∞–∑–≤–∞</th>
                  <th>–ú—ñ—Å—Ç–æ</th>
                  <th>–¶—ñ–Ω–∞</th>
                  <th>–ë—Ä–æ–Ω—é–≤–∞–Ω—å</th>
                </tr>
              </thead>
              <tbody id="popularTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ===== TAB 2: BOOKINGS ===== -->
      <div id="bookings" class="tab-content">
        <div class="content full-width">
          <div class="grid-2">
            <!-- –§–æ—Ä–º–∞ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è -->
            <div class="section">
              <h2>‚úàÔ∏è –ó–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏ —Ç—É—Ä</h2>
              <form id="bookingForm">
                <div class="form-group">
                  <label for="bookTourId">ID –¢—É—Ä—É *</label>
                  <input type="number" id="bookTourId" required min="1" />
                  <small style="color: #999; display: block; margin-top: 5px">
                    üí° –í–∏–±–µ—Ä—ñ—Ç—å ID –∑ —Ç–∞–±–ª–∏—Ü—ñ "–î–æ—Å—Ç—É–ø–Ω—ñ —Ç—É—Ä–∏" –≤–∏—â–µ
                  </small>
                </div>
                <div class="form-group">
                  <label for="bookTouristId">ID –¢—É—Ä–∏—Å—Ç–∞ *</label>
                  <select id="bookTouristId" required>
                    <option value="">-- –û–±–µ—Ä—ñ—Ç—å —Ç—É—Ä–∏—Å—Ç–∞ --</option>
                  </select>
                  <small style="color: #999; display: block; margin-top: 5px">
                    üí° –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫...
                  </small>
                </div>
                <div class="form-group">
                  <label for="bookTravelDate">–î–∞—Ç–∞ –ø–æ–¥–æ—Ä–æ–∂—ñ *</label>
                  <input type="date" id="bookTravelDate" required />
                  <small
                    id="travelDateHint"
                    style="color: #999; display: block; margin-top: 5px"
                    >–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É —É –º–µ–∂–∞—Ö –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ä–æ–∑–∫–ª–∞–¥—ñ–≤ —Ç—É—Ä—É –∞–±–æ
                    –∑–∞–ª–∏—à—Ç–µ –ø–æ–ª–µ –ø–æ—Ä–æ–∂–Ω—ñ–º, —â–æ–± –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –Ω–∞–π–±–ª–∏–∂—á—É
                    –¥–æ—Å—Ç—É–ø–Ω—É –¥–∞—Ç—É.</small
                  >
                </div>
                <button type="submit">‚úàÔ∏è –ó–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏</button>
                <div id="bookingMessage" class="message"></div>
              </form>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω–∏—Ö –±—Ä–æ–Ω—é–≤–∞–Ω—å -->
            <div class="section">
              <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
              <div
                style="padding: 20px; background: #f0f0f0; border-radius: 5px"
              >
                <p>
                  <strong>–í—Å—å–æ–≥–æ –±—Ä–æ–Ω—é–≤–∞–Ω—å:</strong>
                  <span id="bookingCount">0</span>
                </p>
                <p>
                  <strong>–ó–∞ —Å—å–æ–≥–æ–¥–Ω—ñ:</strong> <span id="bookingToday">0</span>
                </p>
                <button onclick="loadBookings()" class="refresh-btn">
                  üîÑ –û–Ω–æ–≤–∏—Ç–∏
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="section full-width">
          <div class="header-row">
            <h2>üìÖ –í—Å—ñ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è</h2>
            <button class="refresh-btn" onclick="loadBookings()">
              üîÑ –û–Ω–æ–≤–∏—Ç–∏
            </button>
          </div>
          <div id="bookingsLoading" class="loading">
            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—Ä–æ–Ω—é–≤–∞–Ω—å...
          </div>
          <div id="bookingsEmpty" class="empty-state" style="display: none">
            –ù–µ–º–∞—î –±—Ä–æ–Ω—é–≤–∞–Ω—å
          </div>

          <table id="bookingsTable" style="display: none">
            <thead>
              <tr>
                <th>ID –ë—Ä–æ–Ω—å</th>
                <th>–¢—É—Ä</th>
                <th>ID –¢—É—Ä–∏—Å—Ç–∞</th>
                <th>–î–∞—Ç–∞ –ø–æ–¥–æ—Ä–æ–∂—ñ</th>
                <th>–î–∞—Ç–∞ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è</th>
                <th>–î—ñ—ó</th>
              </tr>
            </thead>
            <tbody id="bookingsTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- ===== TAB 3: REVIEWS ===== -->
      <div id="reviews" class="tab-content">
        <div class="content full-width">
          <div class="grid-2">
            <!-- –§–æ—Ä–º–∞ –≤—ñ–¥–≥—É–∫—É -->
            <div class="section">
              <h2>‚≠ê –ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</h2>
              <form id="reviewForm">
                <div class="form-group">
                  <label for="revTourId">ID –¢—É—Ä—É *</label>
                  <input type="number" id="revTourId" required min="1" />
                </div>
                <div class="form-group">
                  <label for="revTouristId">ID –¢—É—Ä–∏—Å—Ç–∞ *</label>
                  <input type="number" id="revTouristId" required min="1" />
                </div>
                <div class="form-group">
                  <label for="revRating">–†–µ–π—Ç–∏–Ω–≥ (1-5) *</label>
                  <input
                    type="number"
                    id="revRating"
                    required
                    min="1"
                    max="5"
                  />
                </div>
                <div class="form-group">
                  <label for="revTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                  <input
                    type="text"
                    id="revTitle"
                    placeholder="–í–∞—à –∑–∞–≥–æ–ª–æ–≤–æ–∫..."
                  />
                </div>
                <div class="form-group">
                  <label for="revComment">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
                  <textarea
                    id="revComment"
                    placeholder="–í–∞—à –≤—ñ–¥–≥—É–∫..."
                  ></textarea>
                </div>
                <button type="submit">‚≠ê –û—Ç–ø—Ä–∞–≤–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
                <div id="reviewMessage" class="message"></div>
              </form>
            </div>

            <!-- –†–µ–π—Ç–∏–Ω–≥–∏ —Ç—É—Ä—ñ–≤ -->
            <div class="section">
              <h2>üìä –†–µ–π—Ç–∏–Ω–≥–∏ —Ç—É—Ä—ñ–≤</h2>
              <form onsubmit="getAverageRating(event)">
                <div class="form-group">
                  <label for="ratingTourId">ID –¢—É—Ä—É *</label>
                  <input type="number" id="ratingTourId" required min="1" />
                </div>
                <button type="submit">üìä –û—Ç—Ä–∏–º–∞—Ç–∏ —Ä–µ–π—Ç–∏–Ω–≥</button>
              </form>
              <div id="ratingResult" class="message"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== TAB 4: PAYMENTS ===== -->
      <div id="payments" class="tab-content">
        <div class="content full-width">
          <div class="grid-2">
            <!-- –§–æ—Ä–º–∞ –ø–ª–∞—Ç–µ–∂—É -->
            <div class="section">
              <h2>üí≥ –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–ª–∞—Ç—ñ–∂</h2>
              <form id="paymentForm">
                <div class="form-group">
                  <label for="payBookingId">ID –ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è *</label>
                  <input type="number" id="payBookingId" required min="1" />
                </div>
                <div class="form-group">
                  <label for="payMethodId">–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç–∏ *</label>
                  <select id="payMethodId" required>
                    <option value="">-- –û–±–µ—Ä—ñ—Ç—å --</option>
                    <option value="1">–ö—Ä–µ–¥–∏—Ç–Ω–∞ –∫–∞—Ä—Ç–∞</option>
                    <option value="2">PayPal</option>
                    <option value="3">–ë–∞–Ω–∫—ñ–≤—Å—å–∫–∏–π –ø–µ—Ä–µ–∫–∞–∑</option>
                    <option value="4">–ì–æ—Ç—ñ–≤–∫–∞</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="payAmount">–°—É–º–∞ ($) *</label>
                  <input
                    type="number"
                    id="payAmount"
                    required
                    min="1"
                    step="0.01"
                  />
                </div>
                <button type="submit">üí≥ –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–ª–∞—Ç—ñ–∂</button>
                <div id="paymentMessage" class="message"></div>
              </form>
            </div>

            <!-- –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–ª–∞—Ç–µ–∂—É -->
            <div class="section">
              <h2>‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –ø–ª–∞—Ç—ñ–∂</h2>
              <form id="confirmPaymentForm">
                <div class="form-group">
                  <label for="confirmPaymentId">ID –ü–ª–∞—Ç–µ–∂—É *</label>
                  <input type="number" id="confirmPaymentId" required min="1" />
                </div>
                <div class="form-group">
                  <label for="transactionId">Transaction ID *</label>
                  <input
                    type="text"
                    id="transactionId"
                    placeholder="TXN-123456..."
                    required
                  />
                </div>
                <button type="submit">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
                <div id="confirmPaymentMessage" class="message"></div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = window.location.origin;
      const tourSchedulesCache = {};

      // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
      document.addEventListener("DOMContentLoaded", () => {
        loadTours();
        loadBookings();
        loadPopularTours();
        loadTourists();

        const tourInput = document.getElementById("bookTourId");
        if (tourInput) {
          const syncTourDates = () => {
            const tourId = parseInt(tourInput.value, 10);
            if (Number.isFinite(tourId) && tourId > 0) {
              updateTravelDateHint(tourId);
            } else {
              updateTravelDateHint(null);
            }
          };
          tourInput.addEventListener("change", syncTourDates);
          tourInput.addEventListener("blur", syncTourDates);
          syncTourDates();
        }
      });

      // –û–±—Ä–æ–±–Ω–∏–∫–∏ —Ñ–æ—Ä–º
      document
        .getElementById("bookingForm")
        .addEventListener("submit", handleBooking);
      document
        .getElementById("reviewForm")
        .addEventListener("submit", handleReview);
      document
        .getElementById("paymentForm")
        .addEventListener("submit", handlePayment);
      document
        .getElementById("confirmPaymentForm")
        .addEventListener("submit", handleConfirmPayment);
      document
        .getElementById("createTourForm")
        .addEventListener("submit", handleCreateTour);

      function parseDateFromInput(value) {
        if (!value) return null;
        const [year, month, day] = value.split("-").map(Number);
        if (!year || !month || !day) return null;
        return new Date(Date.UTC(year, month - 1, day));
      }

      function parseDateFromServer(value) {
        if (!value) return null;
        const datePart = value.split("T")[0];
        return parseDateFromInput(datePart);
      }

      function formatHumanDate(date) {
        if (!date) return "";
        return date.toLocaleDateString("uk-UA", {
          day: "2-digit",
          month: "long",
          year: "numeric",
        });
      }

      function toInputDateValue(date) {
        if (!date) return "";
        const year = date.getUTCFullYear();
        const month = String(date.getUTCMonth() + 1).padStart(2, "0");
        const day = String(date.getUTCDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function todayUtc() {
        const now = new Date();
        return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
      }

      async function getTourSchedules(tourId, forceRefresh = false) {
        if (!tourId || tourId <= 0) return [];
        if (!forceRefresh && tourSchedulesCache[tourId]) {
            return tourSchedulesCache[tourId];
        }
        try {
          const response = await fetch(`${API_BASE}/api/tours/${tourId}/schedules`);
          if (!response.ok) return [];
          const schedules = await response.json();
          tourSchedulesCache[tourId] = schedules;
          return schedules;
        } catch (error) {
          console.error("Error loading schedules:", error);
          return [];
        }
      }

      async function updateTravelDateHint(tourId) {
        const hint = document.getElementById("travelDateHint");
        if (!hint) return;

        if (!tourId) {
          hint.textContent = "–í–≤–µ–¥—ñ—Ç—å ID —Ç—É—Ä—É, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –¥–∞—Ç–∏.";
          return;
        }

        hint.textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–æ—Å—Ç—É–ø–Ω—ñ –¥–∞—Ç–∏...";
        const schedules = await getTourSchedules(tourId, true);
        if (!schedules.length) {
          hint.textContent = "–ù–∞—Ä–∞–∑—ñ –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ä–æ–∑–∫–ª–∞–¥—ñ–≤ –¥–ª—è —Ü—å–æ–≥–æ —Ç—É—Ä—É.";
          return;
        }

        const openSchedules = schedules
          .filter(
            (s) =>
              (s.status || "").toLowerCase() === "open" &&
              (s.availableSpots === undefined || s.availableSpots > 0)
          )
          .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

        if (!openSchedules.length) {
          hint.textContent = "–£—Å—ñ —Ä–æ–∑–∫–ª–∞–¥–∏ –¥–ª—è —Ç—É—Ä—É –∑–∞–∫—Ä–∏—Ç—ñ.";
          return;
        }

        const nextDate = parseDateFromServer(openSchedules[0].startDate);
        const parts = [`–ù–∞–π–±–ª–∏–∂—á–∞ –¥–∞—Ç–∞: ${formatHumanDate(nextDate)}`];
        if (openSchedules[0].availableSpots !== undefined) {
          parts.push(`–º—ñ—Å—Ü—å: ${openSchedules[0].availableSpots}`);
        }
        hint.textContent = parts.join(" ¬∑ ");

        const input = document.getElementById("bookTravelDate");
        if (input && !input.value) {
          input.value = toInputDateValue(nextDate);
        }
      }

      async function pickScheduleForDate(tourId, desiredDate) {
        const schedules = await getTourSchedules(tourId, true);
        const openSchedules = schedules
          .filter(
            (s) =>
              (s.status || "").toLowerCase() === "open" &&
              (s.availableSpots === undefined || s.availableSpots > 0)
          )
          .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

        if (!openSchedules.length) {
          return { match: null, all: [] };
        }

        const referenceDate = desiredDate || todayUtc();
        const match = openSchedules.find(
          (s) => parseDateFromServer(s.startDate) >= referenceDate
        );

        return { match: match || null, all: openSchedules };
      }

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è –≤–∫–ª–∞–¥–æ–∫
      function switchTab(tabName) {
        // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ –≤–∫–ª–∞–¥–∫–∏
        document
          .querySelectorAll(".tab-content")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));

        // –ü–æ–∫–∞–∑–∞—Ç–∏ –≤–∏–±—Ä–∞–Ω—É –≤–∫–ª–∞–¥–∫—É
        document.getElementById(tabName).classList.add("active");
        event.target.classList.add("active");
      }

      // ===== TOURS =====
      async function loadTours() {
        try {
          const response = await fetch(`${API_BASE}/api/tours`);
          if (!response.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç—É—Ä—ñ–≤");

          const tours = await response.json();
          displayTours(tours);
        } catch (error) {
          console.error("Error:", error);
          document.getElementById("toursLoading").textContent =
            "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç—É—Ä—ñ–≤";
          document.getElementById("toursEmpty").style.display = "block";
        }
      }

      async function loadPopularTours() {
        try {
          const response = await fetch(`${API_BASE}/api/tours/popular`);
          if (!response.ok) return;

          const tours = await response.json();
          const tbody = document.getElementById("popularTableBody");
          tbody.innerHTML = "";
          tours.slice(0, 5).forEach((tour) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${escapeHtml(tour.name)}</td>
              <td>${escapeHtml(tour.city)}</td>
              <td class="price">$${tour.price.toFixed(2)}</td>
              <td>${tour.bookings || 0}</td>
            `;
            tbody.appendChild(row);
          });
          document.getElementById("popularTable").style.display = "table";
          document.getElementById("popularLoading").style.display = "none";
        } catch (error) {
          console.error("Error:", error);
        }
      }

      function displayTours(tours) {
        const tbody = document.getElementById("toursTableBody");
        const table = document.getElementById("toursTable");
        const loading = document.getElementById("toursLoading");
        const empty = document.getElementById("toursEmpty");

        loading.style.display = "none";

        if (tours.length === 0) {
          empty.style.display = "block";
          return;
        }

        tbody.innerHTML = "";
        tours.forEach((tour) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${tour.tourId}</td>
            <td>${escapeHtml(tour.name)}</td>
            <td>${escapeHtml(tour.country)}</td>
            <td>${escapeHtml(tour.city)}</td>
            <td class="price">$${tour.price.toFixed(2)}</td>
            <td class="rating">‚≠ê ${tour.rating.toFixed(1)}</td>
          `;
          tbody.appendChild(row);
        });

        table.style.display = "table";
        empty.style.display = "none";
      }

      async function loadTourists() {
        try {
          const response = await fetch(`${API_BASE}/api/tourists`);
          if (!response.ok) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç—É—Ä–∏—Å—Ç—ñ–≤");
            return;
          }

          const tourists = await response.json();
          const select = document.getElementById("bookTouristId");

          // –û—á–∏—Å—Ç–∏—Ç–∏ –≤–∏–±—ñ—Ä
          select.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å —Ç—É—Ä–∏—Å—Ç–∞ --</option>';

          // –î–æ–±–∞–≤–∏—Ç–∏ —Ç—É—Ä–∏—Å—Ç—ñ–≤
          tourists.forEach((tourist) => {
            const option = document.createElement("option");
            option.value = tourist.touristId;
            option.textContent = `${tourist.firstName} ${tourist.lastName} (ID: ${tourist.touristId})`;
            select.appendChild(option);
          });

          if (tourists.length === 0) {
            const option = document.createElement("option");
            option.value = "";
            option.textContent = "-- –ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ç—É—Ä–∏—Å—Ç—ñ–≤ --";
            option.disabled = true;
            select.appendChild(option);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function handleCreateTour(e) {
        e.preventDefault();

        const name = document.getElementById("tourName").value;
        const description = document.getElementById("tourDescription").value;
        const destinationCityId = parseInt(
          document.getElementById("tourCityId").value
        );
        const durationDays = parseInt(
          document.getElementById("tourDuration").value
        );
        const maxParticipants = parseInt(
          document.getElementById("tourMaxParticipants").value
        );
        const price = parseFloat(document.getElementById("tourPrice").value);
        const difficulty = document.getElementById("tourDifficulty").value;

        const messageDiv = document.getElementById("createTourMessage");
        messageDiv.className = "message";

        try {
          const response = await fetch(`${API_BASE}/api/tours`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name,
              description,
              destinationCityId,
              durationDays,
              maxParticipants,
              price,
              difficulty,
            }),
          });

          const result = await response.json();
          if (!response.ok)
            throw new Error(result.error || "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ —Ç—É—Ä—É");

          messageDiv.className = "message success";
          messageDiv.textContent = `‚úÖ –¢—É—Ä —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ! ID: ${result.tourId}`;
          document.getElementById("createTourForm").reset();
          setTimeout(loadTours, 500);
        } catch (error) {
          messageDiv.className = "message error";
          messageDiv.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
        }
      }

      // ===== BOOKINGS =====
      async function loadBookings() {
        try {
          const response = await fetch(`${API_BASE}/api/bookings`);
          if (!response.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—Ä–æ–Ω—é–≤–∞–Ω—å");

          const bookings = await response.json();
          displayBookings(bookings);

          // –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          document.getElementById("bookingCount").textContent = bookings.length;
          const today = new Date().toLocaleDateString("uk-UA");
          const todayCount = bookings.filter(
            (b) => new Date(b.bookingDate).toLocaleDateString("uk-UA") === today
          ).length;
          document.getElementById("bookingToday").textContent = todayCount;
        } catch (error) {
          console.error("Error:", error);
          document.getElementById("bookingsLoading").style.display = "none";
          document.getElementById("bookingsEmpty").style.display = "block";
        }
      }

      function displayBookings(bookings) {
        const tbody = document.getElementById("bookingsTableBody");
        const table = document.getElementById("bookingsTable");
        const loading = document.getElementById("bookingsLoading");
        const empty = document.getElementById("bookingsEmpty");

        loading.style.display = "none";

        if (bookings.length === 0) {
          empty.style.display = "block";
          return;
        }

        tbody.innerHTML = "";
        bookings.forEach((booking) => {
          const row = document.createElement("tr");
          const travelDate = new Date(booking.travelDate).toLocaleDateString(
            "uk-UA"
          );
          const bookingDate = new Date(booking.bookingDate).toLocaleString(
            "uk-UA"
          );

          row.innerHTML = `
            <td><strong>${booking.bookingId}</strong></td>
            <td>${escapeHtml(booking.tourName)}</td>
            <td>${booking.touristId}</td>
            <td>${travelDate}</td>
            <td><span class="booking-date">${bookingDate}</span></td>
            <td class="actions">
              <button class="delete" onclick="deleteBooking(${
                booking.bookingId
              })">‚ùå –í–∏–¥–∞–ª–∏—Ç–∏</button>
            </td>
          `;
          tbody.appendChild(row);
        });

        table.style.display = "table";
        empty.style.display = "none";
      }

      async function handleBooking(e) {
        e.preventDefault();

        const tourId = parseInt(document.getElementById("bookTourId").value);
        if (!Number.isFinite(tourId) || tourId <= 0) {
          const messageDiv = document.getElementById("bookingMessage");
          messageDiv.className = "message error";
          messageDiv.textContent = "‚ùå –í–∫–∞–∂—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π ID —Ç—É—Ä—É";
          return;
        }

        let touristId = document.getElementById("bookTouristId").value;
        if (!touristId) {
          const messageDiv = document.getElementById("bookingMessage");
          messageDiv.className = "message error";
          messageDiv.textContent = "‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ç—É—Ä–∏—Å—Ç–∞";
          return;
        }

        touristId = parseInt(touristId);
        const travelDateStr = document.getElementById("bookTravelDate").value;
        const desiredDate = parseDateFromInput(travelDateStr);
        const numberOfPeople = 1;

        const messageDiv = document.getElementById("bookingMessage");
        messageDiv.className = "message";

        try {
          const { match: scheduleMatch, all: availableSchedules } =
            await pickScheduleForDate(tourId, desiredDate);

          if (!scheduleMatch) {
            const hintMessage = availableSchedules.length
              ? `–û—Å—Ç–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–∞—Ç–∞: ${formatHumanDate(
                  parseDateFromServer(
                    availableSchedules[availableSchedules.length - 1].startDate
                  )
                )}.`
              : "–î–ª—è —Ü—å–æ–≥–æ —Ç—É—Ä—É –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ä–æ–∑–∫–ª–∞–¥—ñ–≤.";
            messageDiv.className = "message error";
            messageDiv.textContent =
              "–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –¥–∞—Ç –ø—ñ—Å–ª—è –æ–±—Ä–∞–Ω–æ—ó. " + hintMessage;
            return;
          }

          const scheduleDate = parseDateFromServer(scheduleMatch.startDate);
          const travelDate = scheduleDate.toISOString();
          const usedSuggestedDate =
            !desiredDate || scheduleDate.getTime() !== desiredDate.getTime();

          const travelInput = document.getElementById("bookTravelDate");
          if (travelInput) {
            travelInput.value = toInputDateValue(scheduleDate);
          }

          const response = await fetch(`${API_BASE}/api/bookings`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              tourId,
              touristId,
              travelDate,
              numberOfPeople,
            }),
          });

          const result = await response.json();
          if (!response.ok)
            throw new Error(result.error || "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è");

          messageDiv.className = "message success";
          const scheduleText = formatHumanDate(scheduleDate);
          const extraNote = usedSuggestedDate
            ? " (—Å–∫–æ—Ä–∏–≥–æ–≤–∞–Ω–æ –¥–æ –Ω–∞–π–±–ª–∏–∂—á–æ—ó –¥–æ—Å—Ç—É–ø–Ω–æ—ó –¥–∞—Ç–∏)"
            : "";
          messageDiv.textContent = `‚úÖ –ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è —É—Å–ø—ñ—à–Ω–µ! ID: ${
            result.bookingId
          }. –î–∞—Ç–∞ —Ç—É—Ä—É: ${scheduleText}${extraNote}`;

          const bookingForm = document.getElementById("bookingForm");
          if (bookingForm) {
            bookingForm.reset();
            document.getElementById("bookTourId").value = tourId;
            document.getElementById("bookTouristId").value = "";
          }

          delete tourSchedulesCache[tourId];
          updateTravelDateHint(tourId);
          loadTourists(); // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏–º–æ —Ç—É—Ä–∏—Å—Ç—ñ–≤
          setTimeout(loadBookings, 500);
        } catch (error) {
          messageDiv.className = "message error";
          messageDiv.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
        }
      }

      async function deleteBooking(bookingId) {
        if (!confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ?")) return;

        try {
          const response = await fetch(
            `${API_BASE}/api/bookings/${bookingId}`,
            { method: "DELETE" }
          );
          if (!response.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è");

          alert("‚úÖ –ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ!");
          loadBookings();
        } catch (error) {
          alert(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`);
        }
      }

      // ===== REVIEWS =====
      async function handleReview(e) {
        e.preventDefault();

        const tourId = parseInt(document.getElementById("revTourId").value);
        const touristId = parseInt(
          document.getElementById("revTouristId").value
        );
        const rating = parseInt(document.getElementById("revRating").value);
        const title = document.getElementById("revTitle").value;
        const comment = document.getElementById("revComment").value;

        const messageDiv = document.getElementById("reviewMessage");
        messageDiv.className = "message";

        try {
          const response = await fetch(`${API_BASE}/api/reviews`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tourId, touristId, rating, title, comment }),
          });

          if (!response.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ–¥–≥—É–∫—É");

          messageDiv.className = "message success";
          messageDiv.textContent = "‚úÖ –í—ñ–¥–≥—É–∫ —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!";
          document.getElementById("reviewForm").reset();
        } catch (error) {
          messageDiv.className = "message error";
          messageDiv.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
        }
      }

      async function getAverageRating(e) {
        e.preventDefault();

        const tourId = parseInt(document.getElementById("ratingTourId").value);
        const resultDiv = document.getElementById("ratingResult");
        resultDiv.className = "message";

        try {
          const response = await fetch(
            `${API_BASE}/api/tours/${tourId}/average-rating`
          );
          if (!response.ok) throw new Error("–¢—É—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π");

          const data = await response.json();
          resultDiv.className = "message success";
          resultDiv.textContent = `‚≠ê –°–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥: ${(
            data.averageRating || 0
          ).toFixed(1)}/5`;
        } catch (error) {
          resultDiv.className = "message error";
          resultDiv.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
        }
      }

      // ===== PAYMENTS =====
      async function handlePayment(e) {
        e.preventDefault();

        const bookingId = parseInt(
          document.getElementById("payBookingId").value
        );
        const methodId = parseInt(document.getElementById("payMethodId").value);
        const amount = parseFloat(document.getElementById("payAmount").value);

        const messageDiv = document.getElementById("paymentMessage");
        messageDiv.className = "message";

        try {
          const response = await fetch(`${API_BASE}/api/payments`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              bookingId,
              paymentMethodId: methodId,
              amount,
            }),
          });

          const result = await response.json();
          if (!response.ok)
            throw new Error(result.error || "–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–ª–∞—Ç–µ–∂—É");

          messageDiv.className = "message success";
          messageDiv.textContent = `‚úÖ –ü–ª–∞—Ç—ñ–∂ —Å—Ç–≤–æ—Ä–µ–Ω–æ! ID: ${result.paymentId}`;
          document.getElementById("paymentForm").reset();
        } catch (error) {
          messageDiv.className = "message error";
          messageDiv.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
        }
      }

      async function handleConfirmPayment(e) {
        e.preventDefault();

        const paymentId = parseInt(
          document.getElementById("confirmPaymentId").value
        );
        const transactionId = document.getElementById("transactionId").value;

        const messageDiv = document.getElementById("confirmPaymentMessage");
        messageDiv.className = "message";

        try {
          const response = await fetch(
            `${API_BASE}/api/payments/${paymentId}/confirm`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ transactionId }),
            }
          );

          if (!response.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–ª–∞—Ç–µ–∂—É");

          messageDiv.className = "message success";
          messageDiv.textContent = "‚úÖ –ü–ª–∞—Ç—ñ–∂ —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ!";
          document.getElementById("confirmPaymentForm").reset();
        } catch (error) {
          messageDiv.className = "message error";
          messageDiv.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
        }
      }

      // –£—Ç–∏–ª—ñ—Ç–∞ –¥–ª—è –µ–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
